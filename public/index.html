<!--
  Vue3 æ”¹å¯«æŸ¥è©¢é é¢
  1. ä½¿ç”¨ CDN æ–¹å¼å¼•å…¥ Vue3
  2. ä»¥ table å‘ˆç¾æŸ¥è©¢çµæœ
  3. data: big mac index json è³‡æ–™
  4. method: é¸æ“‡ name å¾Œè‡ªå‹• fetch /api/quotes
  5. æ¯æ¬¡ä¿®æ”¹çš†æœ‰è¨»è§£
-->
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>Big Mac Index æŸ¥è©¢ (Vue3)</title>
  <link rel="stylesheet" href="/stylesheets/style.css">
  <!-- ä¿®æ­£ï¼šæ”¹ç”¨é–‹ç™¼ç‰ˆæœ¬çš„ Vue3 CDNï¼Œä¾¿æ–¼èª¿è©¦éŒ¯èª¤ -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <!-- ä¿®æ­£ï¼šç§»é™¤ Chart.jsï¼Œåœ–è¡¨åŠŸèƒ½æš«æ™‚æ”¹ç‚ºé–‹ç™¼ä¸­ç‹€æ…‹ -->
  <!-- <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> -->
  <!-- ä¿®æ­£ï¼šç§»é™¤ Vue 3 åœ–è¡¨è¨ˆç®—çµ„åˆå¼å‡½æ•¸ -->
  <!-- <script src="/chart-computed-vue.js"></script> -->
</head>
<body>
  <div id="app">
    <h1>Big Mac Index æŸ¥è©¢ (Vue3)</h1>
    <!-- ä¸‹æ‹‰é¸å–®ï¼Œé¸æ“‡åœ‹å®¶/åœ°å€ -->
    <label>æŸ¥è©¢åœ‹å®¶/åœ°å€ï¼š
      <select v-model="selectedName" @change="fetchByName" class="custom-select">
        <option value="">è«‹é¸æ“‡</option>
        <option v-for="name in names" :key="name" :value="name">{{ name }}</option>
      </select>
    </label>
    <!-- æ–°å¢ï¼šå¹´ä»½ä¸‹æ‹‰é¸å–®ï¼Œåƒ…åœ¨å·²é¸æ“‡åœ‹å®¶/åœ°å€æ™‚é¡¯ç¤º -->
    <label v-if="selectedName">é¸æ“‡å¹´ä»½ï¼š
      <select v-model="selectedYear">
        <option value="">å…¨éƒ¨å¹´ä»½</option>
        <option v-for="year in years" :key="year" :value="year">{{ year }}</option>
      </select>
    </label>
    <!-- æ–°å¢ï¼šæ¯”è¼ƒä¸‹æ‹‰é¸å–®ï¼Œåƒ…åœ¨å·²é¸æ“‡åœ‹å®¶/åœ°å€æ™‚é¡¯ç¤º -->
    <label v-if="selectedName">æ¯”è¼ƒåœ‹å®¶/åœ°å€ï¼š
      <select v-model="compareCountry" @change="fetchCompareData" class="custom-select">
        <option value="">è«‹é¸æ“‡æ¯”è¼ƒå°è±¡</option>
        <option v-for="name in names" :key="name" :value="name" :disabled="name === selectedName">{{ name }}</option>
      </select>
    </label>
    <!-- æ–°å¢ï¼šæ’åºé¸é …ï¼Œåƒ…åœ¨æœ‰æŸ¥è©¢çµæœæ™‚é¡¯ç¤º -->
    <label v-if="result.length || compareResult.length">æ’åºæ–¹å¼ï¼š
      <select v-model="sortOrder" class="custom-select">
        <option value="asc">æ—¥æœŸå‡åº</option>
        <option value="desc">æ—¥æœŸé™åº</option>
      </select>
    </label>
    <!-- æ–°å¢ï¼šåœ–è¡¨æ¨¡å¼åˆ‡æ›æŒ‰éˆ•ï¼Œåƒ…åœ¨æœ‰æŸ¥è©¢çµæœæ™‚é¡¯ç¤º -->
    <div v-if="result.length" class="chart-toggle">
      <button @click="toggleChartMode" class="chart-btn">
        {{ isChartMode ? 'åˆ‡æ›åˆ°è¡¨æ ¼æ¨¡å¼' : 'åˆ‡æ›åˆ°åœ–è¡¨æ¨¡å¼' }}
      </button>
    </div>
    <!-- æŸ¥è©¢çµæœå€åŸŸ -->
    <div class="table-container" v-if="!isChartMode">
      <!-- ä¸»è¦æŸ¥è©¢çµæœ table -->
      <div class="table-section" v-if="result.length">
        <h2>{{ selectedName }} æŸ¥è©¢çµæœ</h2>
        <table border="1">
          <thead>
            <tr>
              <th>æ—¥æœŸ</th>
              <th>åœ‹å®¶/åœ°å€</th>
              <th>è²¨å¹£ä»£ç¢¼</th>
              <th>ç•¶åœ°åƒ¹æ ¼</th>
              <th>åŒ¯ç‡</th>
              <th>ç¾å…ƒåƒ¹æ ¼</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="row in sortedResult" :key="row.date + row.name">
              <td>{{ row.date }}</td>
              <td>{{ row.name }}</td>
              <td>{{ row.currency_code }}</td>
              <td>{{ row.local_price }}</td>
              <td>{{ row.dollar_ex }}</td>
              <td>{{ row.dollar_price }}</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div v-else-if="selectedName" class="table-section">
        <h2>{{ selectedName }} æŸ¥è©¢çµæœ</h2>
        <p>æŸ¥ç„¡è³‡æ–™</p>
      </div>

      <!-- æ¯”è¼ƒçµæœ tableï¼Œåƒ…åœ¨æœ‰æ¯”è¼ƒçµæœæ™‚é¡¯ç¤º -->
      <div class="table-section" v-if="compareResult.length">
        <h2>{{ compareCountry }} æ¯”è¼ƒçµæœ</h2>
        <table border="1">
          <thead>
            <tr>
              <th>æ—¥æœŸ</th>
              <th>åœ‹å®¶/åœ°å€</th>
              <th>è²¨å¹£ä»£ç¢¼</th>
              <th>ç•¶åœ°åƒ¹æ ¼</th>
              <th>åŒ¯ç‡</th>
              <th>ç¾å…ƒåƒ¹æ ¼</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="row in sortedCompareResult" :key="row.date + row.name">
              <td>{{ row.date }}</td>
              <td>{{ row.name }}</td>
              <td>{{ row.currency_code }}</td>
              <td>{{ row.local_price }}</td>
              <td>{{ row.dollar_ex }}</td>
              <td>{{ row.dollar_price }}</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div v-else-if="compareCountry" class="table-section">
        <h2>{{ compareCountry }} æ¯”è¼ƒçµæœ</h2>
        <p>æŸ¥ç„¡æ¯”è¼ƒè³‡æ–™</p>
      </div>
    </div>

    <!-- æ–°å¢ï¼šåœ–è¡¨æ¨¡å¼å®¹å™¨ -->
    <div class="chart-container" v-if="isChartMode && result.length">
      <h2>{{ selectedName }} åƒ¹æ ¼èµ°å‹¢åœ–</h2>
      <div class="development-notice">
        <h3>ğŸš§ åŠŸèƒ½é–‹ç™¼ä¸­ ğŸš§</h3>
        <p>åœ–è¡¨åŠŸèƒ½æ­£åœ¨é–‹ç™¼ä¸­ï¼Œæ•¬è«‹æœŸå¾…ï¼</p>
        <p>ç›®å‰åƒ…æä¾›è¡¨æ ¼æ¨¡å¼æŸ¥çœ‹æ•¸æ“šã€‚</p>
      </div>
    </div>
  </div>

  <style>
    .custom-select {
      padding: 4px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 1rem;
      margin-left: 4px;
    }
    label {
      font-weight: bold;
      margin-right: 8px;
    }
    /* æ–°å¢ï¼šè¡¨æ ¼å®¹å™¨æ¨£å¼ - ä¿®æ”¹ç‚ºå·¦å³ä¸¦æ’ */
    .table-container {
      display: flex;
      flex-direction: row;
      gap: 16px;
      margin-top: 16px;
      align-items: flex-start;
    }
    /* æ–°å¢ï¼šå–®å€‹è¡¨æ ¼å€å¡Šæ¨£å¼ - èª¿æ•´ç‚ºç­‰å¯¬ */
    .table-section {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 16px;
      background-color: #fff;
      flex: 1;
      min-width: 0;
    }
    /* æ–°å¢ï¼šè¡¨æ ¼è‡ªé©æ‡‰å¯¬åº¦ */
    .table-section table {
      width: 100%;
      font-size: 0.9rem;
    }
    /* æ–°å¢ï¼šéŸ¿æ‡‰å¼è¨­è¨ˆ - å°è¢å¹•æ™‚å‚ç›´æ’åˆ— */
    @media (max-width: 768px) {
      .table-container {
        flex-direction: column;
      }
    }
    /* æ–°å¢ï¼šåœ–è¡¨æ¨¡å¼æŒ‰éˆ•æ¨£å¼ */
    .chart-toggle {
      margin: 16px 0;
    }
    .chart-btn {
      padding: 8px 16px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
    }
    .chart-btn:hover {
      background-color: #0056b3;
    }
    /* æ–°å¢ï¼šåœ–è¡¨å®¹å™¨æ¨£å¼ */
    .chart-container {
      margin-top: 16px;
      padding: 16px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background-color: #fff;
    }
    .chart-container canvas {
      max-height: 400px;
    }
    /* æ–°å¢ï¼šé–‹ç™¼ä¸­æç¤ºæ¨£å¼ */
    .development-notice {
      padding: 16px;
      background-color: #fff3cd;
      border: 1px solid #ffeeba;
      border-radius: 8px;
      margin-top: 16px;
      text-align: center;
    }
    .development-notice h3 {
      margin: 0 0 8px 0;
      color: #856404;
    }
    .development-notice p {
      margin: 0;
      color: #856404;
    }
  </style>

  <script>
    // ä¿®æ­£ï¼šæ·»åŠ éŒ¯èª¤è™•ç†å’Œ Vue æ‡‰ç”¨åˆå§‹åŒ–æª¢æŸ¥
    try {
      // æª¢æŸ¥ Vue æ˜¯å¦æ­£ç¢ºè¼‰å…¥
      if (typeof Vue === 'undefined') {
        console.error('Vue 3 æœªæ­£ç¢ºè¼‰å…¥ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š');
        document.getElementById('app').innerHTML = '<h1>è¼‰å…¥éŒ¯èª¤</h1><p>Vue 3 æ¡†æ¶æœªæ­£ç¢ºè¼‰å…¥ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šä¸¦é‡æ–°æ•´ç†é é¢ã€‚</p>';
        throw new Error('Vue 3 æœªè¼‰å…¥');
      }

      console.log('Vue 3 å·²è¼‰å…¥ï¼Œç‰ˆæœ¬:', Vue.version);

      // å»ºç«‹ Vue3 æ‡‰ç”¨
      const { createApp } = Vue;
      const app = createApp({
        data() {
          return {
            names: [], // æ‰€æœ‰åœ‹å®¶/åœ°å€åç¨±
            years: [], // è©² name å°æ‡‰çš„æ‰€æœ‰å¹´ä»½
            selectedName: '', // ç•¶å‰é¸æ“‡çš„ name
            selectedYear: '', // ç•¶å‰é¸æ“‡çš„å¹´ä»½
            result: [], // æŸ¥è©¢çµæœ
            compareCountry: '', // ç•¶å‰é¸æ“‡çš„æ¯”è¼ƒåœ‹å®¶/åœ°å€
            compareResult: [], // æ¯”è¼ƒæŸ¥è©¢çµæœ
            sortOrder: 'asc', // æ’åºæ–¹å¼ï¼š'asc' æˆ– 'desc'
            isChartMode: false // åœ–è¡¨æ¨¡å¼é–‹é—œï¼ˆä¿®æ­£ï¼šç§»é™¤ chart å¯¦ä¾‹ï¼Œç°¡åŒ–ç‚ºé–‹ç™¼ä¸­ç‹€æ…‹ï¼‰
          }
        },
        mounted() {
          console.log('Vue æ‡‰ç”¨å·²æ›è¼‰');
          // è¼‰å…¥æ‰€æœ‰ name
          this.fetchNames().catch(error => {
            console.error('è¼‰å…¥åœ‹å®¶è³‡æ–™å¤±æ•—:', error);
          });
        },
        methods: {
          // å–å¾—æ‰€æœ‰ name
          async fetchNames() {
            try {
              // è¨»è§£: å–å¾—æ‰€æœ‰åœ‹å®¶/åœ°å€åç¨±
              const res = await fetch('/api/names');
              if (!res.ok) {
                throw new Error(`HTTP ${res.status}: ${res.statusText}`);
              }
              this.names = await res.json();
              console.log('æˆåŠŸè¼‰å…¥', this.names.length, 'å€‹åœ‹å®¶/åœ°å€');
            } catch (error) {
              console.error('fetchNames éŒ¯èª¤:', error);
              alert('ç„¡æ³•è¼‰å…¥åœ‹å®¶è³‡æ–™ï¼Œè«‹æª¢æŸ¥ä¼ºæœå™¨é€£ç·š');
            }
          },
          // ä¾ name æŸ¥è©¢ï¼Œä¸¦å–å¾—å¹´ä»½
          async fetchByName() {
            try {
              // è¨»è§£: ç•¶é¸æ“‡ name æˆ–å¹´ä»½æ™‚è‡ªå‹•æŸ¥è©¢
              if (!this.selectedName) {
                this.result = [];
                this.years = [];
                this.selectedYear = '';
                return;
              }
              // æŸ¥è©¢è©² name çš„æ‰€æœ‰è³‡æ–™
              let url = `/api/bigmac?name=${encodeURIComponent(this.selectedName)}`;
              const res = await fetch(url);
              if (!res.ok) {
                throw new Error(`HTTP ${res.status}: ${res.statusText}`);
              }
              let allData = await res.json();
              // åƒ…ä¿ç•™æ­£ç¢º name çš„è³‡æ–™ï¼ˆä¿®æ­£ï¼šç¢ºä¿åªé¡¯ç¤ºé¸å®šåœ‹å®¶è³‡æ–™ï¼‰
              allData = allData.filter(row => row.name === this.selectedName);

              // ä¿®æ­£ï¼šå»é™¤é‡è¤‡è³‡æ–™ï¼ŒåŸºæ–¼æ—¥æœŸå’Œåœ‹å®¶çµ„åˆçš„å”¯ä¸€æ€§
              const uniqueData = [];
              const seenKeys = new Set();
              allData.forEach(row => {
                const key = `${row.date}-${row.name}`;
                if (!seenKeys.has(key)) {
                  seenKeys.add(key);
                  uniqueData.push(row);
                }
              });

              // å–å¾—æ‰€æœ‰å¹´ä»½
              const yearSet = new Set();
              uniqueData.forEach(row => {
                if (row.date && row.date.length >= 4) yearSet.add(row.date.slice(0, 4));
              });
              this.years = Array.from(yearSet).sort();
              // ä¿®æ­£ï¼šè‹¥é¸æ“‡äº†å¹´ä»½ï¼Œå‰‡åªé¡¯ç¤ºè©²å¹´ä»½è³‡æ–™
              if (this.selectedYear) {
                this.result = uniqueData.filter(row => row.date && row.date.startsWith(this.selectedYear));
              } else {
                this.result = uniqueData;
              }
              console.log('æŸ¥è©¢çµæœ:', this.result.length, 'ç­†è³‡æ–™');
            } catch (error) {
              console.error('fetchByName éŒ¯èª¤:', error);
              alert('æŸ¥è©¢è³‡æ–™å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
          },
          // æ–°å¢ï¼šä¾æ¯”è¼ƒåœ‹å®¶æŸ¥è©¢è³‡æ–™
          async fetchCompareData() {
            try {
              // è¨»è§£: æŸ¥è©¢æ¯”è¼ƒåœ‹å®¶çš„è³‡æ–™
              if (!this.compareCountry) {
                this.compareResult = [];
                return;
              }

              let url = `/api/bigmac?name=${encodeURIComponent(this.compareCountry)}`;
              const res = await fetch(url);
              if (!res.ok) {
                throw new Error(`HTTP ${res.status}: ${res.statusText}`);
              }
              let allData = await res.json();
              // åƒ…ä¿ç•™æ­£ç¢º name çš„è³‡æ–™
              allData = allData.filter(row => row.name === this.compareCountry);

              // å»é™¤é‡è¤‡è³‡æ–™
              const uniqueData = [];
              const seenKeys = new Set();
              allData.forEach(row => {
                const key = `${row.date}-${row.name}`;
                if (!seenKeys.has(key)) {
                  seenKeys.add(key);
                  uniqueData.push(row);
                }
              });

              // è‹¥é¸æ“‡äº†å¹´ä»½ï¼Œå‰‡åªé¡¯ç¤ºè©²å¹´ä»½è³‡æ–™
              if (this.selectedYear) {
                this.compareResult = uniqueData.filter(row => row.date && row.date.startsWith(this.selectedYear));
              } else {
                this.compareResult = uniqueData;
              }
              console.log('æ¯”è¼ƒçµæœ:', this.compareResult.length, 'ç­†è³‡æ–™');
            } catch (error) {
              console.error('fetchCompareData éŒ¯èª¤:', error);
              alert('æŸ¥è©¢æ¯”è¼ƒè³‡æ–™å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
          },
          // æ–°å¢ï¼šåˆ‡æ›åœ–è¡¨æ¨¡å¼
          toggleChartMode() {
            this.isChartMode = !this.isChartMode;
            // è¨»è§£: åœ–è¡¨åŠŸèƒ½æš«æ™‚ç‚ºé–‹ç™¼ä¸­ç‹€æ…‹ï¼Œåƒ…åˆ‡æ›é¡¯ç¤ºæ¨¡å¼
            console.log('åœ–è¡¨æ¨¡å¼:', this.isChartMode ? 'é–‹å•Ÿ' : 'é—œé–‰');
          }
        },
        computed: {
          // æ ¹æ“šé¸æ“‡çš„æ’åºæ–¹å¼è¿”å›æ’åºå¾Œçš„çµæœ
          sortedResult() {
            // ä¿®æ­£ï¼šå…ˆæ ¹æ“šå¹´ä»½ç¯©é¸ï¼Œå†é€²è¡Œæ’åº
            let filteredData = this.result;

            // å¦‚æœé¸æ“‡äº†å¹´ä»½ï¼Œå‰‡åªé¡¯ç¤ºè©²å¹´ä»½çš„è³‡æ–™
            if (this.selectedYear) {
              filteredData = this.result.filter(row =>
                row.date && row.date.startsWith(this.selectedYear)
              );
            }

            return filteredData.slice().sort((a, b) => {
              const dateA = new Date(a.date);
              const dateB = new Date(b.date);
              return this.sortOrder === 'asc' ? dateA - dateB : dateB - dateA;
            });
          },
          // æ–°å¢ï¼šæ’åºå¾Œçš„æ¯”è¼ƒçµæœ
          sortedCompareResult() {
            // ä¿®æ­£ï¼šå…ˆæ ¹æ“šå¹´ä»½ç¯©é¸ï¼Œå†é€²è¡Œæ’åº
            let filteredData = this.compareResult;

            // å¦‚æœé¸æ“‡äº†å¹´ä»½ï¼Œå‰‡åªé¡¯ç¤ºè©²å¹´ä»½çš„è³‡æ–™
            if (this.selectedYear) {
              filteredData = this.compareResult.filter(row =>
                row.date && row.date.startsWith(this.selectedYear)
              );
            }

            return filteredData.slice().sort((a, b) => {
              const dateA = new Date(a.date);
              const dateB = new Date(b.date);
              return this.sortOrder === 'asc' ? dateA - dateB : dateB - dateA;
            });
          }
        },
        watch: {
          // ç•¶é¸æ“‡çš„ name æ”¹è®Šæ™‚ï¼Œé‡è¨­å¹´ä»½ä¸¦è‡ªå‹•æŸ¥è©¢
          selectedName(newVal, oldVal) {
            // ä¿®æ­£ï¼šæ¸…ç©ºæ‰€æœ‰ç›¸é—œè³‡æ–™ï¼Œé¿å…æ®˜ç•™ä¸Šæ¬¡æŸ¥è©¢çµæœ
            this.result = [];
            this.years = [];
            this.selectedYear = '';

            if (newVal) {
              this.fetchByName();
            }
          },
          // ç•¶å¹´ä»½è®Šå‹•æ™‚è‡ªå‹•æŸ¥è©¢
          selectedYear(newVal, oldVal) {
            // ä¿®æ­£ï¼šå¹´ä»½æ”¹è®Šæ™‚ç«‹å³é‡æ–°æŸ¥è©¢ï¼Œç¢ºä¿è³‡æ–™æ­£ç¢ºæ›´æ–°
            if (this.selectedName) {
              this.fetchByName();
            }
            // æ–°å¢ï¼šå¹´ä»½è®Šå‹•æ™‚ï¼ŒåŒæ­¥æ›´æ–°æ¯”è¼ƒåœ‹å®¶çš„è³‡æ–™
            if (this.compareCountry) {
              this.fetchCompareData();
            }
          },
          // ç•¶æ¯”è¼ƒåœ‹å®¶è®Šæ›´æ™‚ï¼Œè‡ªå‹•æŸ¥è©¢è©²åœ‹å®¶è³‡æ–™
          compareCountry(newVal, oldVal) {
            if (newVal) {
              this.fetchCompareData();
            } else {
              this.compareResult = [];
            }
          }
        }
      });

      // æ›è¼‰æ‡‰ç”¨ä¸¦æ·»åŠ éŒ¯èª¤è™•ç†
      const mountedApp = app.mount('#app');
      console.log('Vue æ‡‰ç”¨æˆåŠŸæ›è¼‰åˆ° #app');

    } catch (error) {
      console.error('Vue æ‡‰ç”¨åˆå§‹åŒ–å¤±æ•—:', error);
      // æä¾›å‚™ç”¨çš„ HTML å…§å®¹
      document.getElementById('app').innerHTML = `
        <h1>æ‡‰ç”¨è¼‰å…¥å¤±æ•—</h1>
        <p>Vue 3 æ‡‰ç”¨ç„¡æ³•æ­£ç¢ºåˆå§‹åŒ–ï¼ŒéŒ¯èª¤è¨Šæ¯ï¼š${error.message}</p>
        <p>è«‹å˜—è©¦ä»¥ä¸‹è§£æ±ºæ–¹æ¡ˆï¼š</p>
        <ul>
          <li>é‡æ–°æ•´ç†é é¢</li>
          <li>æª¢æŸ¥ç¶²è·¯é€£ç·š</li>
          <li>ç¢ºèªä¼ºæœå™¨æ­£åœ¨é‹è¡Œ</li>
        </ul>
      `;
    }
  </script>
</body>
</html>
