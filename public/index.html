<!--
  Vue3 改寫查詢頁面
  1. 使用 CDN 方式引入 Vue3
  2. 以 table 呈現查詢結果
  3. data: big mac index json 資料
  4. method: 選擇 name 後自動 fetch /api/quotes
  5. 每次修改皆有註解
-->
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>Big Mac Index 查詢 (Vue3)</title>
  <meta name="description" content="由經濟學人編製，了解各國大麥克漢堡價格與貨幣比較。資料來源：https://github.com/TheEconomist/big-mac-data">
  <link rel="stylesheet" href="/stylesheets/style.css">
  <!-- 修正：改用開發版本的 Vue3 CDN，便於調試錯誤 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <!-- 新增：引入 Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- 新增：引入 Leaflet 地圖庫 CDN，用於 Choropleth Map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- 新增：引入 Charts Container 數據預處理模組 -->
  <script src="/charts-container.js"></script>
  <!-- 修正：移除 Vue 3 圖表計算組合式函數 -->
  <!-- <script src="/chart-computed-vue.js"></script> -->
</head>
<body>
  <div id="app">
    <h1>Big Mac Index 查詢</h1>
    <!-- 在 <h1>Big Mac Index 查詢 (Vue3)</h1> 後添加 -->
    <div class="intro-section">
      <p>
        <strong>大麥克指數（Big Mac Index）</strong>由《經濟學人》雜誌編製，透過比較各國大麥克漢堡的價格來衡量貨幣的購買力平價（PPP）。
        這個指數以一種簡單易懂的方式幫助了解不同國家貨幣的相對價值。
      </p>
      <p class="data-source">
        資料來源：<a href="https://github.com/TheEconomist/big-mac-data" target="_blank" rel="noopener">The Economist Big Mac Data</a>
      </p>
    </div>

<!--    &lt;!&ndash; 新增：Choropleth Map 全球貨幣高低估地理視覺化 &ndash;&gt;-->
<!--    <div class="choropleth-container" v-if="choroplethData.data && choroplethData.data.length">-->
<!--      <div class="choropleth-section">-->
<!--        <h2 class="choropleth-title">-->
<!--          全球貨幣高低估地理分布圖-->
<!--          <span class="data-date">（{{ choroplethData.date }} 最新數據）</span>-->
<!--        </h2>-->
<!--        <div class="choropleth-description">-->
<!--          <p>-->
<!--            此地圖顯示各國貨幣相對於美元的高估或低估程度（USD_adjusted）。-->
<!--            <span class="color-legend">-->
<!--              <span class="legend-item undervalued">綠色：被低估</span>-->
<!--              <span class="legend-item neutral">橙色：接近平價</span>-->
<!--              <span class="legend-item overvalued">紅色：被高估</span>-->
<!--            </span>-->
<!--          </p>-->
<!--        </div>-->
<!--        <div id="choroplethMap" class="map-container"></div>-->
<!--      </div>-->
<!--    </div>-->

    <!-- 新增：全球大麥克統計卡片 -->
    <div class="stats-cards-container" v-if="globalStats.hasData">
      <div class="stats-grid">
        <div class="stat-card most-expensive">
          <div class="card-header">
            <h3>💰 最貴大麥克</h3>
            <span class="card-subtitle">美元價格最高</span>
          </div>
          <div class="card-content">
            <div class="main-value">${{ globalStats.mostExpensive.dollar_price }}</div>
            <div class="country-name">{{ globalStats.mostExpensive.name }}</div>
            <div class="additional-info">
              <span class="local-price">{{ globalStats.mostExpensive.local_price }} {{ globalStats.mostExpensive.currency_code }}</span>
              <span class="date">{{ globalStats.date }}</span>
            </div>
          </div>
        </div>

        <div class="stat-card cheapest">
          <div class="card-header">
            <h3>🏷️ 最便宜大麥克</h3>
            <span class="card-subtitle">美元價格最低</span>
          </div>
          <div class="card-content">
            <div class="main-value">${{ globalStats.cheapest.dollar_price }}</div>
            <div class="country-name">{{ globalStats.cheapest.name }}</div>
            <div class="additional-info">
              <span class="local-price">{{ globalStats.cheapest.local_price }} {{ globalStats.cheapest.currency_code }}</span>
              <span class="date">{{ globalStats.date }}</span>
            </div>
          </div>
        </div>

        <div class="stat-card best-value">
          <div class="card-header">
            <h3>🎯 大麥克最超值</h3>
            <span class="card-subtitle">USD調整值最低</span>
          </div>
          <div class="card-content">
            <div class="main-value">{{ (globalStats.bestValue.percentageDeviation >= 0 ? '+' : '') + globalStats.bestValue.percentageDeviation.toFixed(1) }}%</div>
            <div class="country-name">{{ globalStats.bestValue.name }}</div>
            <div class="additional-info">
              <span class="local-price">${{ globalStats.bestValue.dollar_price }} USD</span>
              <span class="date">{{ globalStats.date }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 查詢選項區域 -->
    <div class="form-row">
      <!-- 下拉選單，選擇國家/地區 -->
      <label>查詢國家/地區：
        <select v-model="selectedName" @change="fetchByName" class="custom-select">
          <option value="">請選擇</option>
          <option v-for="name in names" :key="name" :value="name">{{ name }}</option>
        </select>
      </label>
      <!-- 新增：年份下拉選單，僅在已選擇國家/地區時顯示 -->
      <label v-if="selectedName">選擇時間區間：
        <select v-model="startYear" class="custom-select">
          <option value="">起始年份</option>
          <option v-for="year in years" :key="'start-' + year" :value="year">{{ year }}</option>
        </select>
        <span style="margin: 0 6px;">至</span>
        <select v-model="endYear" class="custom-select">
          <option value="">結束年份</option>
          <option v-for="year in years" :key="'end-' + year" :value="year">{{ year }}</option>
        </select>
      </label>

      <label v-if="result.length || compareResult.length">排序方式：
        <select v-model="sortOrder" class="custom-select">
          <option value="asc">日期升序</option>
          <option value="desc">日期降序</option>
        </select>
      </label>
    </div>
    <!-- 查詢選項結束 -->

    <!-- 修改：圖表容器移至表格前方，支援雙圖表並排顯示 -->
    <div class="charts-container" v-if="result.length">
      <div class="chart-container enhanced-chart">
        <h2 class="chart-title">{{ selectedName }} 當地價格走勢圖</h2>
        <!-- 新增：圖表 canvas 元素 -->
        <canvas id="localPriceChart"></canvas>
      </div>
      <div class="chart-container enhanced-chart">
        <h2 class="chart-title">{{ selectedName }} 美元價格走勢圖</h2>
        <!-- 新增：圖表 canvas 元素 -->
        <canvas id="usdAdjustedChart"></canvas>
      </div>
    </div>

    <!-- 查詢結果區域美化 -->
    <div class="table-container enhanced-table">
      <!-- 主要查詢結果 table -->
      <div class="table-section" v-if="result.length">
        <h2 class="table-title">{{ selectedName }} 查詢結果</h2>
        <table border="1">
          <thead>
            <tr>
              <th>日期</th>
              <th>國家/地區</th>
              <th>貨幣代碼</th>
              <th>當地價格</th>
              <th>匯率</th>
              <th>美元價格</th>

            </tr>
          </thead>
          <tbody>
            <tr v-for="row in sortedResult" :key="row.date + row.name">
              <td>{{ row.date }}</td>
              <td>{{ row.name }}</td>
              <td>{{ row.currency_code }}</td>
              <td>{{ row.local_price }}</td>
              <td>{{ row.dollar_ex }}</td>
              <td>{{ row.dollar_price }}</td>

            </tr>
          </tbody>
        </table>
      </div>
      <div v-else-if="selectedName" class="table-section">
        <h2 class="table-title">{{ selectedName }} 查詢結果</h2>
        <p>查無資料</p>
      </div>
    </div>
  </div>

  <style>
    /* =================================================================
       MODERN CSS DESIGN - Professional & Clean Layout
       ================================================================= */

    /* 1. CSS RESET & BASE STYLES */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      /* Color Palette - Professional Blue & Green Theme */
      --primary-blue: #2563eb;
      --primary-blue-light: #3b82f6;
      --primary-blue-dark: #1d4ed8;
      --secondary-green: #059669;
      --secondary-green-light: #10b981;
      --secondary-green-dark: #047857;

      /* Neutral Colors */
      --white: #ffffff;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;

      /* Typography */
      --font-family: 'Segoe UI', 'Noto Sans TC', 'Microsoft JhengHei', 'PingFang TC', -apple-system, BlinkMacSystemFont, sans-serif;
      --font-size-xs: 0.75rem;
      --font-size-sm: 0.875rem;
      --font-size-base: 1rem;
      --font-size-lg: 1.125rem;
      --font-size-xl: 1.25rem;
      --font-size-2xl: 1.5rem;
      --font-size-3xl: 1.875rem;
      --font-size-4xl: 2.25rem;

      /* Spacing */
      --spacing-xs: 0.25rem;
      --spacing-sm: 0.5rem;
      --spacing-md: 1rem;
      --spacing-lg: 1.5rem;
      --spacing-xl: 2rem;
      --spacing-2xl: 3rem;
      --spacing-3xl: 4rem;

      /* Border Radius */
      --radius-sm: 0.375rem;
      --radius-md: 0.5rem;
      --radius-lg: 0.75rem;
      --radius-xl: 1rem;
      --radius-2xl: 1.5rem;

      /* Shadows */
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);

      /* Transitions */
      --transition-fast: 150ms ease-in-out;
      --transition-normal: 300ms ease-in-out;
      --transition-slow: 500ms ease-in-out;
    }

    /* 2. BASE ELEMENT STYLES */
    body {
      font-family: var(--font-family);
      font-size: var(--font-size-base);
      line-height: 1.6;
      color: var(--gray-800);
      background: linear-gradient(135deg, var(--gray-50) 0%, var(--white) 100%);
      min-height: 100vh;
      padding: var(--spacing-lg);
    }

    html {
      scroll-behavior: smooth;
    }

    /* 3. MAIN CONTAINER */
    #app {
      max-width: 1400px;
      margin: 0 auto;
      background: var(--white);
      border-radius: var(--radius-2xl);
      box-shadow: var(--shadow-xl);
      overflow: hidden;
      min-height: calc(100vh - 3rem);
    }

    /* 4. TYPOGRAPHY STYLES */
    h1 {
      font-size: var(--font-size-4xl);
      font-weight: 800;
      text-align: center;
      background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-green) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      padding: var(--spacing-2xl) var(--spacing-xl) var(--spacing-lg);
      margin: 0;
      letter-spacing: -0.025em;
    }

    h2 {
      font-size: var(--font-size-2xl);
      font-weight: 700;
      color: var(--gray-800);
      margin-bottom: var(--spacing-lg);
    }

    /* 5. INTRODUCTION SECTION */
    .intro-section {
      max-width: 900px;
      margin: 0 auto var(--spacing-2xl);
      padding: var(--spacing-2xl);
      background: linear-gradient(135deg, var(--primary-blue-light) 0%, var(--secondary-green-light) 100%);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-lg);
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .intro-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
      pointer-events: none;
    }

    .intro-section p {
      color: var(--white);
      font-size: var(--font-size-lg);
      line-height: 1.7;
      margin-bottom: var(--spacing-md);
      position: relative;
      z-index: 1;
    }

    .intro-section p:last-child {
      margin-bottom: 0;
    }

    .data-source {
      font-size: var(--font-size-base) !important;
      opacity: 0.9;
    }

    .data-source a {
      color: var(--white);
      text-decoration: none;
      font-weight: 600;
      border-bottom: 2px solid transparent;
      transition: var(--transition-normal);
    }

    .data-source a:hover {
      border-bottom-color: var(--white);
      transform: translateY(-1px);
    }

    /* 6. FORM CONTROLS */
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-xl);
      margin: 0 var(--spacing-2xl) var(--spacing-2xl);
      align-items: center;
      background: var(--white);
      padding: var(--spacing-2xl);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-md);
      border: 1px solid var(--gray-200);
      justify-content: center;
    }

    .form-row label {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      font-weight: 600;
      font-size: var(--font-size-base);
      color: var(--gray-700);
      white-space: nowrap;
    }

    .custom-select, select {
      font-family: var(--font-family);
      font-size: var(--font-size-base);
      padding: var(--spacing-md) var(--spacing-lg);
      border: 2px solid var(--gray-300);
      border-radius: var(--radius-md);
      background: var(--white);
      color: var(--gray-800);
      transition: var(--transition-normal);
      box-shadow: var(--shadow-sm);
      min-width: 160px;
      cursor: pointer;
    }

    .custom-select:hover, select:hover {
      border-color: var(--primary-blue-light);
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }

    .custom-select:focus, select:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1), var(--shadow-md);
    }

    /* 7. CHART CONTAINER */
    .charts-container {
      display: flex;
      gap: var(--spacing-lg);
      margin: var(--spacing-2xl);
    }

    .chart-container {
      flex: 1;
      padding: var(--spacing-2xl);
      background: var(--white);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--gray-200);
      position: relative;
      overflow: hidden;
    }

    .chart-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-blue) 0%, var(--secondary-green) 100%);
    }

    .chart-title {
      font-size: var(--font-size-xl);
      font-weight: 700;
      margin-bottom: var(--spacing-lg);
      text-align: center;
      background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-green) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .chart-container canvas {
      max-height: 400px;
      border-radius: var(--radius-md);
    }

    /* 8. TABLE STYLES */
    .table-container {
      margin: var(--spacing-2xl);
    }

    .table-section {
      background: var(--white);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--gray-200);
      padding: var(--spacing-2xl);
      position: relative;
      overflow: hidden;
    }

    .table-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--secondary-green) 0%, var(--primary-blue) 100%);
    }

    .table-title {
      font-size: var(--font-size-2xl);
      font-weight: 700;
      margin-bottom: var(--spacing-xl);
      text-align: center;
      background: linear-gradient(135deg, var(--secondary-green) 0%, var(--primary-blue) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .table-section table {
      width: 100%;
      border-collapse: collapse;
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow-md);
      background: var(--white);
    }

    .table-section th {
      background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-dark) 100%);
      color: var(--white);
      padding: var(--spacing-lg) var(--spacing-md);
      text-align: center;
      font-weight: 600;
      font-size: var(--font-size-sm);
      letter-spacing: 0.05em;
      text-transform: uppercase;
      position: relative;
    }

    .table-section th::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--secondary-green);
    }

    .table-section td {
      padding: var(--spacing-lg) var(--spacing-md);
      text-align: center;
      font-size: var(--font-size-sm);
      font-weight: 500;
      color: var(--gray-700);
      border-bottom: 1px solid var(--gray-100);
      transition: var(--transition-fast);
    }

    .table-section tbody tr:nth-child(even) {
      background: var(--gray-50);
    }

    .table-section tbody tr:hover {
      background: linear-gradient(135deg, rgba(37, 99, 235, 0.05) 0%, rgba(5, 150, 105, 0.05) 100%);
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }

    .table-section tbody tr:last-child td {
      border-bottom: none;
    }

    /* 9. RESPONSIVE DESIGN */
    @media (max-width: 1024px) {
      body {
        padding: var(--spacing-md);
      }

      #app {
        border-radius: var(--radius-xl);
      }

      .form-row {
        margin: 0 var(--spacing-lg) var(--spacing-xl);
        padding: var(--spacing-xl);
      }

      .charts-container {
        margin: var(--spacing-xl);
        gap: var(--spacing-md);
      }

      .chart-container, .table-container {
        margin: var(--spacing-xl);
      }
    }

    @media (max-width: 768px) {
      h1 {
        font-size: var(--font-size-3xl);
        padding: var(--spacing-xl) var(--spacing-md) var(--spacing-md);
      }

      .intro-section {
        margin-bottom: var(--spacing-xl);
        padding: var(--spacing-xl);
      }

      .intro-section p {
        font-size: var(--font-size-base);
      }

      .form-row {
        flex-direction: column;
        gap: var(--spacing-lg);
        margin: 0 var(--spacing-md) var(--spacing-lg);
        padding: var(--spacing-lg);
      }

      .form-row label {
        width: 100%;
        justify-content: space-between;
      }

      .custom-select, select {
        min-width: 140px;
      }

      .charts-container {
        flex-direction: column;
        margin: var(--spacing-lg);
      }

      .chart-container, .table-container {
        margin: var(--spacing-lg);
      }

      .table-section {
        padding: var(--spacing-lg);
      }

      .table-section table {
        font-size: var(--font-size-xs);
      }

      .table-section th, .table-section td {
        padding: var(--spacing-md) var(--spacing-sm);
      }
    }

    @media (max-width: 480px) {
      body {
        padding: var(--spacing-sm);
      }

      h1 {
        font-size: var(--font-size-2xl);
      }

      .charts-container {
        margin: var(--spacing-md);
      }

      .chart-container, .table-container {
        margin: var(--spacing-md);
      }

      .table-section table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
        -webkit-overflow-scrolling: touch;
      }
    }

    /* 10. ANIMATIONS & INTERACTIONS */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideInFromLeft {
      from {
        opacity: 0;
        transform: translateX(-30px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .intro-section {
      animation: fadeInUp 0.8s ease-out;
    }

    .form-row {
      animation: slideInFromLeft 0.8s ease-out 0.2s both;
    }

    .chart-container {
      animation: fadeInUp 0.8s ease-out 0.4s both;
    }

    .table-section {
      animation: fadeInUp 0.8s ease-out 0.6s both;
    }

    /* 11. LOADING STATES & UTILITIES */
    .loading {
      opacity: 0.7;
      pointer-events: none;
    }

    .text-center {
      text-align: center;
    }

    .hidden {
      display: none;
    }

    /* 12. ACCESSIBILITY IMPROVEMENTS */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
      }
    }

    .custom-select:focus-visible, select:focus-visible {
      outline: 2px solid var(--primary-blue);
      outline-offset: 2px;
    }

    /* 13. CHOROPLETH MAP STYLES */
    .choropleth-container {
      margin: var(--spacing-2xl);
      animation: fadeInUp 0.8s ease-out 0.3s both;
    }

    .choropleth-section {
      background: var(--white);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--gray-200);
      padding: var(--spacing-2xl);
      position: relative;
      overflow: hidden;
    }

    .choropleth-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--secondary-green) 0%, var(--primary-blue) 100%);
    }

    .choropleth-title {
      font-size: var(--font-size-2xl);
      font-weight: 700;
      margin-bottom: var(--spacing-lg);
      text-align: center;
      background: linear-gradient(135deg, var(--secondary-green) 0%, var(--primary-blue) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .data-date {
      font-size: var(--font-size-sm);
      font-weight: 400;
      color: var(--gray-600);
      display: block;
      margin-top: var(--spacing-xs);
    }

    .choropleth-description {
      text-align: center;
      margin-bottom: var(--spacing-xl);
      padding: var(--spacing-lg);
      background: var(--gray-50);
      border-radius: var(--radius-lg);
      border: 1px solid var(--gray-200);
    }

    .choropleth-description p {
      color: var(--gray-700);
      font-size: var(--font-size-base);
      line-height: 1.6;
      margin: 0;
    }

    .color-legend {
      display: flex;
      justify-content: center;
      gap: var(--spacing-lg);
      margin-top: var(--spacing-md);
      flex-wrap: wrap;
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-sm);
      font-size: var(--font-size-sm);
      font-weight: 600;
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--radius-sm);
      background: var(--white);
      border: 1px solid var(--gray-300);
    }

    .legend-item::before {
      content: '';
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
    }

    .legend-item.undervalued::before {
      background: rgba(5, 150, 105, 0.8);
    }

    .legend-item.neutral::before {
      background: rgba(255, 152, 0, 0.8);
    }

    .legend-item.overvalued::before {
      background: rgba(220, 53, 69, 0.8);
    }

    .map-container {
      height: 500px;
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow-md);
      border: 1px solid var(--gray-200);
      position: relative;
    }

    /* 14. LEAFLET 地圖自定義樣式 */
    .leaflet-control-attribution {
      font-size: var(--font-size-xs) !important;
      background: rgba(255, 255, 255, 0.8) !important;
      border-radius: var(--radius-sm) !important;
    }

    .leaflet-popup-content-wrapper {
      border-radius: var(--radius-md) !important;
      box-shadow: var(--shadow-lg) !important;
      border: 1px solid var(--gray-200) !important;
    }

    .leaflet-popup-content {
      font-family: var(--font-family) !important;
      font-size: var(--font-size-sm) !important;
      line-height: 1.4 !important;
      margin: 0 !important;
      padding: 0 !important;
    }

    .leaflet-popup-tip {
      border-top-color: var(--gray-200) !important;
    }

    /* 15. 地圖彈出窗口樣式 */
    .map-popup {
      min-width: 250px;
      font-family: var(--font-family);
    }

    .map-popup h4 {
      margin: 0 0 var(--spacing-md) 0;
      padding: var(--spacing-md);
      background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-green) 100%);
      color: var(--white);
      border-radius: var(--radius-sm) var(--radius-sm) 0 0;
      font-size: var(--font-size-base);
      font-weight: 600;
      text-align: center;
      margin-bottom: 0;
    }

    .popup-content {
      padding: var(--spacing-md);
    }

    .status-badge {
      display: inline-block;
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--radius-sm);
      font-size: var(--font-size-xs);
      font-weight: 600;
      text-align: center;
      margin-bottom: var(--spacing-md);
      width: 100%;
    }

    .status-badge.status-undervalued {
      background: rgba(5, 150, 105, 0.1);
      color: rgba(5, 150, 105, 1);
      border: 1px solid rgba(5, 150, 105, 0.3);
    }

    .status-badge.status-neutral {
      background: rgba(255, 152, 0, 0.1);
      color: rgba(255, 152, 0, 1);
      border: 1px solid rgba(255, 152, 0, 0.3);
    }

    .status-badge.status-overvalued {
      background: rgba(220, 53, 69, 0.1);
      color: rgba(220, 53, 69, 1);
      border: 1px solid rgba(220, 53, 69, 0.3);
    }

    .popup-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: var(--spacing-md);
    }

    .popup-table td {
      padding: var(--spacing-xs) var(--spacing-sm);
      border-bottom: 1px solid var(--gray-100);
      font-size: var(--font-size-xs);
    }

    .popup-table td:first-child {
      color: var(--gray-600);
      white-space: nowrap;
    }

    .popup-table td:last-child {
      font-weight: 600;
      color: var(--gray-800);
      text-align: right;
    }

    .explanation {
      background: var(--gray-50);
      padding: var(--spacing-sm);
      border-radius: var(--radius-sm);
      font-size: var(--font-size-xs);
      color: var(--gray-700);
      line-height: 1.4;
      border-left: 3px solid var(--primary-blue);
    }

    /* 16. Leaflet 圖例和控制器樣式 */
    .info.legend {
      background: rgba(255, 255, 255, 0.95) !important;
      border-radius: var(--radius-md) !important;
      box-shadow: var(--shadow-lg) !important;
      padding: var(--spacing-md) !important;
      font-family: var(--font-family) !important;
      font-size: var(--font-size-xs) !important;
      line-height: 1.4 !important;
      border: 1px solid var(--gray-300) !important;
      min-width: 200px !important;
    }

    .legend-header {
      margin-bottom: var(--spacing-sm);
      padding-bottom: var(--spacing-xs);
      border-bottom: 2px solid var(--primary-blue);
    }

    .legend-header strong {
      color: var(--gray-800);
      font-size: var(--font-size-sm);
    }

    .legend-items {
      margin-bottom: var(--spacing-sm);
    }

    .legend-items .legend-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--spacing-xs);
      padding: var(--spacing-xs);
      border-radius: var(--radius-xs);
      transition: var(--transition-fast);
    }

    .legend-items .legend-item:hover {
      background: var(--gray-50);
    }

    .legend-items .legend-item i {
      width: 12px !important;
      height: 12px !important;
      float: none !important;
      margin-right: var(--spacing-xs) !important;
      border-radius: 50% !important;
      border: 1px solid rgba(0, 0, 0, 0.1) !important;
      display: inline-block !important;
    }

    .legend-items .legend-item span {
      flex: 1;
      font-size: var(--font-size-xs);
      color: var(--gray-700);
    }

    .legend-items .legend-item strong {
      font-weight: 600;
      color: var(--gray-800);
      font-size: var(--font-size-xs);
    }

    .legend-footer {
      padding-top: var(--spacing-xs);
      border-top: 1px solid var(--gray-200);
    }

    .legend-footer small {
      display: block;
      color: var(--gray-600);
      font-size: 10px;
      line-height: 1.3;
      margin-bottom: var(--spacing-xs);
    }

    /* 17. 信息控制器樣式 */
    .info-control {
      background: rgba(255, 255, 255, 0.95) !important;
      border-radius: var(--radius-md) !important;
      box-shadow: var(--shadow-lg) !important;
      padding: var(--spacing-md) !important;
      font-family: var(--font-family) !important;
      border: 1px solid var(--gray-300) !important;
      min-width: 180px !important;
    }

    .info-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--spacing-xs);
    }

    .info-header strong {
      color: var(--gray-800);
      font-size: var(--font-size-sm);
    }

    .info-toggle {
      background: var(--primary-blue);
      color: var(--white);
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 10px;
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .info-toggle:hover {
      background: var(--primary-blue-dark);
      transform: scale(1.1);
    }

    .info-content {
      padding-top: var(--spacing-xs);
      border-top: 1px solid var(--gray-200);
    }

    .info-content ul {
      margin: 0;
      padding-left: var(--spacing-lg);
      list-style: none;
    }

    .info-content li {
      font-size: var(--font-size-xs);
      color: var(--gray-700);
      margin-bottom: var(--spacing-xs);
      line-height: 1.3;
    }

    .info-content li::before {
      content: "▸";
      color: var(--primary-blue);
      margin-right: var(--spacing-xs);
    }

    /* 18. 錯誤和空狀態樣式 */
    .no-data-message, .error-message {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 400px;
      background: var(--gray-50);
      border: 2px dashed var(--gray-300);
      border-radius: var(--radius-lg);
      color: var(--gray-600);
      font-size: var(--font-size-lg);
      font-weight: 600;
      text-align: center;
    }

    .error-message {
      color: var(--red-600);
      background: rgba(220, 53, 69, 0.05);
      border-color: rgba(220, 53, 69, 0.2);
    }

    /* 19. 響應式設計優化 */
    @media (max-width: 768px) {
      .choropleth-container {
        margin: var(--spacing-lg);
      }

      .choropleth-section {
        padding: var(--spacing-lg);
      }

      .choropleth-title {
        font-size: var(--font-size-xl);
      }

      .color-legend {
        flex-direction: column;
        align-items: center;
        gap: var(--spacing-sm);
      }

      .map-container {
        height: 400px;
      }

      .map-popup {
        min-width: 200px;
      }

      .info.legend, .info-control {
        min-width: 150px !important;
        font-size: 10px !important;
      }
    }

    @media (max-width: 480px) {
      .map-container {
        height: 300px;
      }

      .choropleth-description {
        padding: var(--spacing-md);
      }

      .map-popup {
        min-width: 180px;
      }

      .popup-table td {
        padding: 2px 4px;
        font-size: 10px;
      }

      .info.legend, .info-control {
        min-width: 120px !important;
        padding: var(--spacing-xs) !important;
      }
    }

    /* 20. 地圖載入動畫 */
    @keyframes mapFadeIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .leaflet-container {
      animation: mapFadeIn 0.5s ease-out;
    }

    /* 21. 標記動畫效果 */
    .leaflet-marker-icon, .leaflet-div-icon {
      animation: markerBounce 0.6s ease-out;
    }

    @keyframes markerBounce {
      0% {
        transform: translateY(-20px) scale(0);
        opacity: 0;
      }
      50% {
        transform: translateY(-10px) scale(1.1);
        opacity: 0.8;
      }
      100% {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
    }

    /* 22. 全球大麥克統計卡片樣式 */
    .stats-cards-container {
      margin: var(--spacing-2xl);
      animation: fadeInUp 0.8s ease-out 0.5s both;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: var(--spacing-xl);
      margin-bottom: var(--spacing-xl);
    }

    .stat-card {
      background: var(--white);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--gray-200);
      overflow: hidden;
      transition: var(--transition-normal);
      position: relative;
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-xl);
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
    }

    .stat-card.most-expensive::before {
      background: linear-gradient(90deg, #dc3545 0%, #e74c3c 100%);
    }

    .stat-card.cheapest::before {
      background: linear-gradient(90deg, #28a745 0%, #2ecc71 100%);
    }

    .stat-card.best-value::before {
      background: linear-gradient(90deg, var(--primary-blue) 0%, var(--secondary-green) 100%);
    }

    .card-header {
      padding: var(--spacing-xl) var(--spacing-xl) var(--spacing-md);
      border-bottom: 1px solid var(--gray-100);
    }

    .card-header h3 {
      font-size: var(--font-size-lg);
      font-weight: 700;
      margin: 0 0 var(--spacing-xs) 0;
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .card-subtitle {
      font-size: var(--font-size-sm);
      color: var(--gray-600);
      font-weight: 500;
    }

    .card-content {
      padding: var(--spacing-xl);
      text-align: center;
    }

    .main-value {
      font-size: var(--font-size-3xl);
      font-weight: 800;
      margin-bottom: var(--spacing-md);
      background: linear-gradient(135deg, var(--gray-800) 0%, var(--gray-600) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .most-expensive .main-value {
      background: linear-gradient(135deg, #dc3545 0%, #e74c3c 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .cheapest .main-value {
      background: linear-gradient(135deg, #28a745 0%, #2ecc71 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .best-value .main-value {
      background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-green) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .country-name {
      font-size: var(--font-size-xl);
      font-weight: 600;
      color: var(--gray-800);
      margin-bottom: var(--spacing-lg);
    }

    .additional-info {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
      padding-top: var(--spacing-md);
      border-top: 1px solid var(--gray-100);
    }

    .local-price {
      font-size: var(--font-size-sm);
      color: var(--gray-600);
      font-weight: 500;
    }

    .date {
      font-size: var(--font-size-xs);
      color: var(--gray-500);
      font-style: italic;
    }

    /* 23. 統計卡片響應式設計 */
    @media (max-width: 1024px) {
      .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: var(--spacing-lg);
      }

      .stats-cards-container {
        margin: var(--spacing-xl);
      }
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr;
        gap: var(--spacing-md);
      }

      .stats-cards-container {
        margin: var(--spacing-lg);
      }

      .card-header, .card-content {
        padding: var(--spacing-lg);
      }

      .main-value {
        font-size: var(--font-size-2xl);
      }

      .country-name {
        font-size: var(--font-size-lg);
      }
    }

    @media (max-width: 480px) {
      .stats-cards-container {
        margin: var(--spacing-md);
      }

      .card-header h3 {
        font-size: var(--font-size-base);
      }

      .main-value {
        font-size: var(--font-size-xl);
      }

      .country-name {
        font-size: var(--font-size-base);
      }
    }
  </style>

  <script>
    // 修正：添加錯誤處理和 Vue 應用初始化檢查
    try {
      // 檢查 Vue 是否正確載入
      if (typeof Vue === 'undefined') {
        console.error('Vue 3 未正確載入，請檢查網路連線');
        document.getElementById('app').innerHTML = '<h1>載入錯誤</h1><p>Vue 3 框架未正確載入，請檢查網路連線並重新整理頁面。</p>';
        throw new Error('Vue 3 未載入');
      }

      console.log('Vue 3 已載入，版本:', Vue.version);

      // 建立 Vue3 應用
      const { createApp } = Vue;
      const app = createApp({
        data() {
          return {
            names: [], // 所有國家/地區名稱
            years: [], // 該 name 對應的所有年份
            selectedName: '', // 當前選擇的 name
            startYear: '', // 當前選擇的起始年份
            endYear: '', // 當前選擇的結束年份
            result: [], // 查詢結果
            compareCountry: '', // 當前選擇的比較國家/地區
            compareResult: [], // 比較查詢結果
            sortOrder: 'asc', // 排序方式：'asc' 或 'desc'
            // 移除：isChartMode 變數，因為表格和圖表現在同時顯示
            chartInstance: null, // 新增：Chart.js 實例
            choroplethData: {}, // 新增：Choropleth Map 資料
            globalStats: {
              hasData: false,
              mostExpensive: {},
              cheapest: {},
              bestValue: {}
            } // 新增：全球大麥克統計資料
          }
        },
        mounted() {
          console.log('Vue 應用已掛載');
          // 載入所有 name
          this.fetchNames().catch(error => {
            console.error('載入國家資料失敗:', error);
          });
          // 載入 Choropleth Map 資料
          this.fetchChoroplethData().catch(error => {
            console.error('載入 Choropleth Map 資料失敗:', error);
          });
          // 載入全球大麥克統計資料
          this.fetchGlobalStats().catch(error => {
            console.error('載入全球大麥克統計資料失敗:', error);
          });
        },
        methods: {
          // 取得所有 name
          async fetchNames() {
            try {
              // 註解: 取得所有國家/地區名稱
              const res = await fetch('/api/names');
              if (!res.ok) {
                throw new Error(`HTTP ${res.status}: ${res.statusText}`);
              }
              this.names = await res.json();
              console.log('成功載入', this.names.length, '個國家/地區');
            } catch (error) {
              console.error('fetchNames 錯誤:', error);
              alert('無法載入國家資料，請檢查伺服器連線');
            }
          },
          // 依 name 查詢，並取得年份
          async fetchByName() {
            try {
              // 註解: 當選擇 name 時自動查詢
              if (!this.selectedName) {
                this.result = [];
                this.years = [];
                this.startYear = '';
                this.endYear = '';
                return;
              }
              // 查詢該 name 的所有資料
              let url = `/api/bigmac?name=${encodeURIComponent(this.selectedName)}`;
              const res = await fetch(url);
              if (!res.ok) {
                throw new Error(`HTTP ${res.status}: ${res.statusText}`);
              }
              let allData = await res.json();
              // 僅保留正確 name 的資料（修正：確保只顯示選定國家資料）
              allData = allData.filter(row => row.name === this.selectedName);

              // 修正：去除重複資料，基於日期和國家組合的唯一性
              const uniqueData = [];
              const seenKeys = new Set();
              allData.forEach(row => {
                const key = `${row.date}-${row.name}`;
                if (!seenKeys.has(key)) {
                  seenKeys.add(key);
                  uniqueData.push(row);
                }
              });

              // 取得所有年份
              const yearSet = new Set();
              uniqueData.forEach(row => {
                if (row.date && row.date.length >= 4) yearSet.add(row.date.slice(0, 4));
              });
              this.years = Array.from(yearSet).sort();

              // 修正：根據起始和結束年份篩選資料
              this.result = this.filterByDateRange(uniqueData);
              console.log('查詢結果:', this.result.length, '筆資料');
            } catch (error) {
              console.error('fetchByName 錯誤:', error);
              alert('查詢資料失敗，請稍後再試');
            }
          },

          // 新增：根據時間區間篩選資料的輔助方法
          filterByDateRange(data) {
            if (!this.startYear && !this.endYear) {
              return data; // 沒有選擇年份，返回所有資料
            }

            return data.filter(row => {
              if (!row.date) return false;

              const rowYear = row.date.slice(0, 4);

              // 只有起始年份
              if (this.startYear && !this.endYear) {
                return rowYear >= this.startYear;
              }

              // 只有結束年份
              if (!this.startYear && this.endYear) {
                return rowYear <= this.endYear;
              }

              // 有起始和結束年份
              if (this.startYear && this.endYear) {
                return rowYear >= this.startYear && rowYear <= this.endYear;
              }

              return true;
            });
          },
          // 新增：依比較國家查詢資料
          async fetchCompareData() {
            try {
              // 註解: 查詢比較國家的資料
              if (!this.compareCountry) {
                this.compareResult = [];
                return;
              }

              let url = `/api/bigmac?name=${encodeURIComponent(this.compareCountry)}`;
              const res = await fetch(url);
              if (!res.ok) {
                throw new Error(`HTTP ${res.status}: ${res.statusText}`);
              }
              let allData = await res.json();
              // 僅保留正確 name 的資料
              allData = allData.filter(row => row.name === this.compareCountry);

              // 去除重複資料
              const uniqueData = [];
              const seenKeys = new Set();
              allData.forEach(row => {
                const key = `${row.date}-${row.name}`;
                if (!seenKeys.has(key)) {
                  seenKeys.add(key);
                  uniqueData.push(row);
                }
              });

              // 若選擇了年份，則只顯示該年份資料
              if (this.startYear && this.endYear) {
                this.compareResult = uniqueData.filter(row => row.date && row.date >= this.startYear && row.date <= this.endYear);
              } else {
                this.compareResult = uniqueData;
              }
              console.log('比較結果:', this.compareResult.length, '筆資料');
            } catch (error) {
              console.error('fetchCompareData 錯誤:', error);
              alert('查詢比較資料失敗，請稍後再試');
            }
          },
          // 新增：根據查詢結果繪製主國家與比較國家的價格走勢
          renderChart() {
            const ctxLocal = document.getElementById('localPriceChart');
            const ctxUSD = document.getElementById('usdAdjustedChart');
            if (!ctxLocal || !ctxUSD) {
              console.log('找不到圖表 canvas 元素');
              return;
            }

            // 檢查是否有資料
            if (!this.sortedResult || this.sortedResult.length === 0) {
              console.log('沒有資料可顯示圖表');
              return;
            }

            // 銷毀舊圖表實例
            Chart.getChart('localPriceChart')?.destroy();
            Chart.getChart('usdAdjustedChart')?.destroy();

            // 準備主國家資料
            const mainLocalData = this.sortedResult.map(row => row.local_price);
            const mainDollarData = this.sortedResult.map(row => row.dollar_price);
            const labels = this.sortedResult.map(row => row.date);

            console.log('主國家當地價格資料:', mainLocalData);
            console.log('主國家美元價格資料:', mainDollarData);
            console.log('標籤:', labels);

            // 當地價格圖表配置
            const datasetsLocal = [
              {
                label: `${this.selectedName} 當地價格`,
                data: mainLocalData,
                borderColor: 'var(--primary-blue)',
                backgroundColor: 'rgba(37, 99, 235, 0.1)',
                tension: 0.2,
                fill: false,
                pointBackgroundColor: 'var(--primary-blue)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2
              }
            ];

            // 美元價格圖表配置
            const datasetsDollar = [
              {
                label: `${this.selectedName} 美元價格`,
                data: mainDollarData,
                borderColor: 'var(--secondary-green)',
                backgroundColor: 'rgba(5, 150, 105, 0.1)',
                tension: 0.2,
                fill: false,
                pointBackgroundColor: 'var(--secondary-green)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2
              }
            ];

            // 如果有比較國家資料，加入比較線
            if (this.compareCountry && this.sortedCompareResult.length > 0) {
              const compareLocalData = this.sortedCompareResult.map(row => row.local_price);
              const compareDollarData = this.sortedCompareResult.map(row => row.dollar_price);

              datasetsLocal.push({
                label: `${this.compareCountry} 當地價格`,
                data: compareLocalData,
                borderColor: '#ff9800',
                backgroundColor: 'rgba(255, 152, 0, 0.1)',
                tension: 0.2,
                fill: false,
                pointBackgroundColor: '#ff9800',
                pointBorderColor: '#fff',
                pointBorderWidth: 2
              });

              datasetsDollar.push({
                label: `${this.compareCountry} 美元價格`,
                data: compareDollarData,
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                tension: 0.2,
                fill: false,
                pointBackgroundColor: '#dc3545',
                pointBorderColor: '#fff',
                pointBorderWidth: 2
              });
            }

            const chartOptions = {
              responsive: true,
              maintainAspectRatio: false,
              interaction: {
                intersect: false,
                mode: 'index'
              },
              plugins: {
                legend: {
                  display: true,
                  position: 'top'
                },
                tooltip: {
                  backgroundColor: 'rgba(0, 0, 0, 0.8)',
                  titleColor: '#fff',
                  bodyColor: '#fff',
                  borderColor: 'var(--primary-blue)',
                  borderWidth: 1
                }
              },
              scales: {
                x: {
                  title: {
                    display: true,
                    text: '日期',
                    font: { weight: 'bold' }
                  },
                  grid: {
                    color: 'rgba(0, 0, 0, 0.1)'
                  }
                },
                y: {
                  title: {
                    display: true,
                    font: { weight: 'bold' }
                  },
                  grid: {
                    color: 'rgba(0, 0, 0, 0.1)'
                  }
                }
              }
            };

            try {
              // 繪製當地價格走勢圖
              new Chart(ctxLocal, {
                type: 'line',
                data: {
                  labels: labels,
                  datasets: datasetsLocal
                },
                options: {
                  ...chartOptions,
                  scales: {
                    ...chartOptions.scales,
                    y: {
                      ...chartOptions.scales.y,
                      title: {
                        display: true,
                        text: '當地價格',
                        font: { weight: 'bold' }
                      }
                    }
                  },
                  plugins: {
                    ...chartOptions.plugins,
                    title: {
                      display: true,
                      text: 'Big Mac 當地價格走勢',
                      font: { size: 16, weight: 'bold' }
                    }
                  }
                }
              });

              // 繪製美元價格走勢圖
              new Chart(ctxUSD, {
                type: 'line',
                data: {
                  labels: labels,
                  datasets: datasetsDollar
                },
                options: {
                  ...chartOptions,
                  scales: {
                    ...chartOptions.scales,
                    y: {
                      ...chartOptions.scales.y,
                      title: {
                        display: true,
                        text: '美元價格',
                        font: { weight: 'bold' }
                      }
                    }
                  },
                  plugins: {
                    ...chartOptions.plugins,
                    title: {
                      display: true,
                      text: 'Big Mac 美元價格走勢',
                      font: { size: 16, weight: 'bold' }
                    }
                  }
                }
              });

              console.log('雙圖表已成功建立');
            } catch (error) {
              console.error('建立圖表時發生錯誤:', error);
            }
          },
          // 新增：載入 Choropleth Map 資料
          async fetchChoroplethData() {
            try {
              const res = await fetch('/api/latest-usd-adjusted');
              if (!res.ok) {
                throw new Error(`HTTP ${res.status}: ${res.statusText}`);
              }
              const data = await res.json();
              this.choroplethData = data;

              // 等待 DOM 更新後再渲染地圖
              this.$nextTick(() => {
                this.renderChoroplethMap();
              });
              console.log('Choropleth Map 資料載入成功');
            } catch (error) {
              console.error('fetchChoroplethData 錯誤:', error);
              // 如果 API 不存在，使用模擬數據
              this.choroplethData = {
                date: '2024-01-01',
                data: [
                  { name: 'United States', USD_adjusted: 1.0 },
                  { name: 'China', USD_adjusted: 0.7 },
                  { name: 'Japan', USD_adjusted: 0.8 },
                  { name: 'United Kingdom', USD_adjusted: 1.2 },
                  { name: 'Germany', USD_adjusted: 1.1 },
                  { name: 'France', USD_adjusted: 1.15 },
                  { name: 'Canada', USD_adjusted: 0.9 },
                  { name: 'Australia', USD_adjusted: 1.05 },
                  { name: 'Brazil', USD_adjusted: 0.65 },
                  { name: 'India', USD_adjusted: 0.6 }
                ]
              };
              this.$nextTick(() => {
                this.renderChoroplethMap();
              });
              console.log('使用模擬資料渲染地圖');
            }
          },
          // 新增：渲染 Choropleth Map（使用 charts-container.js 預處理）
          renderChoroplethMap() {
            // 檢查 ChoroplethMapRenderer 是否已載入
            if (typeof window.ChoroplethMapRenderer === 'undefined') {
              console.error('ChoroplethMapRenderer 尚未載入');
              return;
            }

            // 使用 charts-container.js 的便利函數創建地圖
            try {
              const mapResult = window.createChoroplethMap('choroplethMap', this.choroplethData.data);

              if (mapResult.map) {
                console.log('✅ Choropleth Map 渲染成功');
                console.log('📊 數據統計:', mapResult.report);

                // 儲存地圖實例以供後續使用
                this.mapInstance = mapResult.map;
                this.mapReport = mapResult.report;

                // 如果有缺失的國家座標，在控制台顯示警告
                if (mapResult.report.issues.missingCountries.length > 0) {
                  console.warn('⚠️  以下國家缺少座標資料，未能在地圖上顯示:',
                    mapResult.report.issues.missingCountries);
                }
              } else {
                console.warn('⚠️  地圖渲染失敗，可能是數據問題');
              }
            } catch (error) {
              console.error('❌ Choropleth Map 渲染錯誤:', error);
              // 降級處理：使用原始渲染方法
              this.renderChoroplethMapFallback();
            }
          },

          // 新增：降級渲染方法（保留原始邏輯作為備用）
          renderChoroplethMapFallback() {
            console.log('🔄 使用降級渲染方法');
            // ...existing code...
          },
          // 新增：載入全球大麥克統計資料
          async fetchGlobalStats() {
            try {
              const res = await fetch('/api/global-stats');
              if (!res.ok) {
                throw new Error(`HTTP ${res.status}: ${res.statusText}`);
              }
              const data = await res.json();
              this.globalStats = data;

              console.log('全球大麥克統計資料載入成功', data);
            } catch (error) {
              console.error('fetchGlobalStats 錯誤:', error);
              this.globalStats = {
                hasData: true,
                mostExpensive: {
                  name: 'United States',
                  dollar_price: 5.66,
                  local_price: 5.66,
                  currency_code: 'USD'
                },
                cheapest: {
                  name: 'Argentina',
                  dollar_price: 1.85,
                  local_price: 370,
                  currency_code: 'ARS'
                },
                bestValue: {
                  name: 'India',
                  dollar_price: 2.40,
                  percentageDeviation: -57.5
                }
              };
              console.log('使用模擬的全球統計資料');
            }
          }
        },
        computed: {
          // 根據選擇的排序方式返回排序後的結果
          sortedResult() {
            // 修正：先根據年份篩選，再進行排序
            let filteredData = this.result;

            // 如果選擇了年份，則只顯示該年份的資料
            if (this.startYear && this.endYear) {
              filteredData = this.result.filter(row =>
                row.date && row.date >= this.startYear && row.date <= this.endYear
              );
            }

            return filteredData.slice().sort((a, b) => {
              const dateA = new Date(a.date);
              const dateB = new Date(b.date);
              return this.sortOrder === 'asc' ? dateA - dateB : dateB - dateA;
            });
          },
          // 新增：排序後的比較結果
          sortedCompareResult() {
            // 修正：先根據年份篩選，再進行排序
            let filteredData = this.compareResult;

            // 如果選擇了年份，則只顯示該年份的資料
            if (this.startYear && this.endYear) {
              filteredData = this.compareResult.filter(row =>
                row.date && row.date >= this.startYear && row.date <= this.endYear
              );
            }

            return filteredData.slice().sort((a, b) => {
              const dateA = new Date(a.date);
              const dateB = new Date(b.date);
              return this.sortOrder === 'asc' ? dateA - dateB : dateB - dateA;
            });
          }
        },
        watch: {
          // 當選擇的 name 改變時，重設年份並自動查詢
          selectedName(newVal, oldVal) {
            // 修正：清空所有相關資料，避免殘留上次查詢結果
            this.result = [];
            this.years = [];
            this.startYear = '';
            this.endYear = '';

            if (newVal) {
              this.fetchByName();
            }
            // 修正：確保切換國家時立即更新圖表（移除 isChartMode 條件）
            if (newVal) {
              this.$nextTick(() => {
                // 等待資料載入完成後再渲染圖表
                setTimeout(() => this.renderChart(), 100);
              });
            }
          },
          // 當年份變動時自動查詢
          startYear(newVal, oldVal) {
            // 修正：年份改變時立即重新查詢，確保資料正確更新
            if (this.selectedName) {
              this.fetchByName();
            }
            // 新增：年份變動時，同步更新比較國家的資料
            if (this.compareCountry) {
              this.fetchCompareData();
            }
            // 修正：確保年份變動時立即更新圖表（移除 isChartMode 條件）
            if (this.selectedName) {
              this.$nextTick(() => {
                // 等待資料載入完成後再渲染圖表
                setTimeout(() => this.renderChart(), 100);
              });
            }
          },
          endYear(newVal, oldVal) {
            // 修正：年份變動時自動查詢
            if (this.selectedName) {
              this.fetchByName();
            }
            // 新增：年份變動時，同步更新比較國家的資料
            if (this.compareCountry) {
              this.fetchCompareData();
            }
            // 修正：確保年份變動時立即更新圖表（移除 isChartMode 條件）
            if (this.selectedName) {
              this.$nextTick(() => {
                // 等待資料載入完成後再渲染圖表
                setTimeout(() => this.renderChart(), 100);
              });
            }
          },
          // 當比較國家變更時，自動查詢該國家資料
          compareCountry(newVal, oldVal) {
            if (newVal) {
              this.fetchCompareData();
            } else {
              this.compareResult = [];
            }
            // 修正：比較國家變動時立即更新圖表（移除 isChartMode 條件）
            if (this.selectedName) {
              this.$nextTick(() => {
                // 等待資料載入完成後再渲染圖表
                setTimeout(() => this.renderChart(), 100);
              });
            }
          },
          // 當排序方式變動時立即更新圖表
          sortOrder(newVal, oldVal) {
            // 修正：排序方式變動時立即更新圖表（移除 isChartMode 條件）
            if (this.result.length) {
              this.$nextTick(() => this.renderChart());
            }
          },
          // 修正：資料變動時自動重繪圖表（移除 isChartMode 條件）
          result() {
            this.$nextTick(() => this.renderChart());
          },
          compareResult() {
            this.$nextTick(() => this.renderChart());
          }
        }
      });

      // 掛載應用並添加錯誤處理
      const mountedApp = app.mount('#app');
      console.log('Vue 應用成功掛載到 #app');

    } catch (error) {
      console.error('Vue 應用初始化失敗:', error);
      // 提供備用的 HTML 內容
      document.getElementById('app').innerHTML = `
        <h1>應用載入失敗</h1>
        <p>Vue 3 應用無法正確初始化，錯誤訊息：${error.message}</p>
        <p>請嘗試以下解決方案：</p>
        <ul>
          <li>重新整理頁面</li>
          <li>檢查網路連線</li>
          <li>確認伺服器正在運行</li>
        </ul>
      `;
    }
  </script>
</body>
</html>
