<!--
  Vue3 改寫查詢頁面
  1. 使用 CDN 方式引入 Vue3
  2. 以 table 呈現查詢結果
  3. data: big mac index json 資料
  4. method: 選擇 name 後自動 fetch /api/quotes
  5. 每次修改皆有註解
-->
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>Big Mac Index 查詢 (Vue3)</title>
  <link rel="stylesheet" href="/stylesheets/style.css">
  <!-- 修正：改用開發版本的 Vue3 CDN，便於調試錯誤 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <!-- 新增：引入 Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- 修正：移除 Vue 3 圖表計算組合式函數 -->
  <!-- <script src="/chart-computed-vue.js"></script> -->
</head>
<body>
  <div id="app">
    <h1>Big Mac Index 查詢 (Vue3)</h1>
    <!-- 查詢選項區域 -->
    <div class="form-row">
      <!-- 下拉選單，選擇國家/地區 -->
      <label>查詢國家/地區：
        <select v-model="selectedName" @change="fetchByName" class="custom-select">
          <option value="">請選擇</option>
          <option v-for="name in names" :key="name" :value="name">{{ name }}</option>
        </select>
      </label>
      <!-- 新增：年份下拉選單，僅在已選擇國家/地區時顯示 -->
      <label v-if="selectedName">選擇年份：
        <select v-model="selectedYear" class="custom-select">
          <option value="">全部年份</option>
          <option v-for="year in years" :key="year" :value="year">{{ year }}</option>
        </select>
      </label>

      <label v-if="result.length || compareResult.length">排序方式：
        <select v-model="sortOrder" class="custom-select">
          <option value="asc">日期升序</option>
          <option value="desc">日期降序</option>
        </select>
      </label>
    </div>
    <!-- 查詢選項結束 -->

    <!-- 修改：圖表容器移至表格前方 -->
    <div class="chart-container enhanced-chart" v-if="result.length">
      <h2 class="chart-title">{{ selectedName }} 價格走勢圖</h2>
      <!-- 新增：圖表 canvas 元素 -->
      <canvas id="bigmacChart"></canvas>
    </div>

    <!-- 查詢結果區域美化 -->
    <div class="table-container enhanced-table">
      <!-- 主要查詢結果 table -->
      <div class="table-section" v-if="result.length">
        <h2 class="table-title">{{ selectedName }} 查詢結果</h2>
        <table border="1">
          <thead>
            <tr>
              <th>日期</th>
              <th>國家/地區</th>
              <th>貨幣代碼</th>
              <th>當地價格</th>
              <th>匯率</th>
              <th>美元價格</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="row in sortedResult" :key="row.date + row.name">
              <td>{{ row.date }}</td>
              <td>{{ row.name }}</td>
              <td>{{ row.currency_code }}</td>
              <td>{{ row.local_price }}</td>
              <td>{{ row.dollar_ex }}</td>
              <td>{{ row.dollar_price }}</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div v-else-if="selectedName" class="table-section">
        <h2 class="table-title">{{ selectedName }} 查詢結果</h2>
        <p>查無資料</p>
      </div>
    </div>
  </div>

  <style>
    body, html, .surface-0, .p-card, .p-panel, .p-dropdown, .p-datatable, .table-container, .table-section, table, th, td, input, select, button {
      font-family: 'Noto Sans TC', 'Microsoft JhengHei', 'PingFang TC', 'Helvetica Neue', Arial, sans-serif !important;
    }
    .custom-select {
      padding: 4px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 1rem;
      margin-left: 4px;
    }
    label {
      font-weight: bold;
      margin-right: 8px;
    }
    /* 新增：表格容器樣式 - 修改為左右並排 */
    .table-container {
      display: flex;
      flex-direction: row;
      gap: 16px;
      margin-top: 16px;
      align-items: flex-start;
    }
    /* 新增：單個表格區塊樣式 - 調整為等寬 */
    .table-section {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 16px;
      background-color: #fff;
      flex: 1;
      min-width: 0;
    }
    /* 新增：表格自適應寬度 */
    .table-section table {
      width: 100%;
      font-size: 0.9rem;
    }
    /* 新增：響應式設計 - 小螢幕時垂直排列 */
    @media (max-width: 768px) {
      .table-container {
        flex-direction: column;
      }
    }
    /* 新增：圖表容器樣式 */
    .chart-container {
      margin-top: 16px;
      padding: 16px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background-color: #fff;
    }
    .chart-container canvas {
      max-height: 400px;
    }
    /* 新增：開發中提示樣式 */
    .development-notice {
      padding: 16px;
      background-color: #fff3cd;
      border: 1px solid #ffeeba;
      border-radius: 8px;
      margin-top: 16px;
      text-align: center;
    }
    .development-notice h3 {
      margin: 0 0 8px 0;
      color: #856404;
    }
    .development-notice p {
      margin: 0;
      color: #856404;
    }
    /* 強制下拉選單字體與字型大小一致 */
    .custom-select, select {
      font-size: 1rem;
      font-family: 'Noto Sans TC', 'Microsoft JhengHei', 'PingFang TC', 'Helvetica Neue', Arial, sans-serif;
      padding: 7px 14px;
      border-radius: 6px;
      border: 1px solid #b0b0b0;
      background: #fff;
      transition: border 0.2s, box-shadow 0.2s;
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
    }
    .custom-select:focus, .custom-select:hover, select:focus, select:hover {
      border-color: #007bff;
      box-shadow: 0 0 0 2px #cce1ff;
      outline: none;
    }
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 18px;
      margin-bottom: 18px;
      align-items: center;
      background: #f8f9fa;
      padding: 16px 18px;
      border-radius: 10px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
    }
    .form-row label {
      font-weight: bold;
      font-size: 1.08rem;
      margin-right: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    /* 修改：圖表容器美化，標題更明顯，區塊加大圓角與陰影 */
    .enhanced-chart {
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      margin-top: 24px;
    }
    .chart-title {
      font-size: 1.5rem;
      font-weight: bold;
      margin: 0 0 16px 0;
      padding: 16px;
      background: linear-gradient(90deg, #007bff, #00c853);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    /* 新增：查詢結果區域美化 */
    .enhanced-table {
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      margin-top: 24px;
    }
    .table-title {
      font-size: 1.5rem;
      font-weight: bold;
      margin: 0 0 16px 0;
      padding: 16px;
      background: linear-gradient(90deg, #007bff, #00c853);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    @media (max-width: 600px) {
      .form-row {
        flex-direction: column;
        gap: 10px;
        padding: 10px;
      }
      .form-row label {
        width: 100%;
        justify-content: flex-start;
      }
    }
  </style>

  <script>
    // 修正：添加錯誤處理和 Vue 應用初始化檢查
    try {
      // 檢查 Vue 是否正確載入
      if (typeof Vue === 'undefined') {
        console.error('Vue 3 未正確載入，請檢查網路連線');
        document.getElementById('app').innerHTML = '<h1>載入錯誤</h1><p>Vue 3 框架未正確載入，請檢查網路連線並重新整理頁面。</p>';
        throw new Error('Vue 3 未載入');
      }

      console.log('Vue 3 已載入，版本:', Vue.version);

      // 建立 Vue3 應用
      const { createApp } = Vue;
      const app = createApp({
        data() {
          return {
            names: [], // 所有國家/地區名稱
            years: [], // 該 name 對應的所有年份
            selectedName: '', // 當前選擇的 name
            selectedYear: '', // 當前選擇的年份
            result: [], // 查詢結果
            compareCountry: '', // 當前選擇的比較國家/地區
            compareResult: [], // 比較查詢結果
            sortOrder: 'asc', // 排序方式：'asc' 或 'desc'
            // 移除：isChartMode 變數，因為表格和圖表現在同時顯示
            chartInstance: null // 新增：Chart.js 實例
          }
        },
        mounted() {
          console.log('Vue 應用已掛載');
          // 載入所有 name
          this.fetchNames().catch(error => {
            console.error('載入國家資料失敗:', error);
          });
        },
        methods: {
          // 取得所有 name
          async fetchNames() {
            try {
              // 註解: 取得所有國家/地區名稱
              const res = await fetch('/api/names');
              if (!res.ok) {
                throw new Error(`HTTP ${res.status}: ${res.statusText}`);
              }
              this.names = await res.json();
              console.log('成功載入', this.names.length, '個國家/地區');
            } catch (error) {
              console.error('fetchNames 錯誤:', error);
              alert('無法載入國家資料，請檢查伺服器連線');
            }
          },
          // 依 name 查詢，並取得年份
          async fetchByName() {
            try {
              // 註解: 當選擇 name 或年份時自動查詢
              if (!this.selectedName) {
                this.result = [];
                this.years = [];
                this.selectedYear = '';
                return;
              }
              // 查詢該 name 的所有資料
              let url = `/api/bigmac?name=${encodeURIComponent(this.selectedName)}`;
              const res = await fetch(url);
              if (!res.ok) {
                throw new Error(`HTTP ${res.status}: ${res.statusText}`);
              }
              let allData = await res.json();
              // 僅保留正確 name 的資料（修正：確保只顯示選定國家資料）
              allData = allData.filter(row => row.name === this.selectedName);

              // 修正：去除重複資料，基於日期和國家組合的唯一性
              const uniqueData = [];
              const seenKeys = new Set();
              allData.forEach(row => {
                const key = `${row.date}-${row.name}`;
                if (!seenKeys.has(key)) {
                  seenKeys.add(key);
                  uniqueData.push(row);
                }
              });

              // 取得所有年份
              const yearSet = new Set();
              uniqueData.forEach(row => {
                if (row.date && row.date.length >= 4) yearSet.add(row.date.slice(0, 4));
              });
              this.years = Array.from(yearSet).sort();
              // 修正：若選擇了年份，則只顯示該年份資料
              if (this.selectedYear) {
                this.result = uniqueData.filter(row => row.date && row.date.startsWith(this.selectedYear));
              } else {
                this.result = uniqueData;
              }
              console.log('查詢結果:', this.result.length, '筆資料');
            } catch (error) {
              console.error('fetchByName 錯誤:', error);
              alert('查詢資料失敗，請稍後再試');
            }
          },
          // 新增：依比較國家查詢資料
          async fetchCompareData() {
            try {
              // 註解: 查詢比較國家的資料
              if (!this.compareCountry) {
                this.compareResult = [];
                return;
              }

              let url = `/api/bigmac?name=${encodeURIComponent(this.compareCountry)}`;
              const res = await fetch(url);
              if (!res.ok) {
                throw new Error(`HTTP ${res.status}: ${res.statusText}`);
              }
              let allData = await res.json();
              // 僅保留正確 name 的資料
              allData = allData.filter(row => row.name === this.compareCountry);

              // 去除重複資料
              const uniqueData = [];
              const seenKeys = new Set();
              allData.forEach(row => {
                const key = `${row.date}-${row.name}`;
                if (!seenKeys.has(key)) {
                  seenKeys.add(key);
                  uniqueData.push(row);
                }
              });

              // 若選擇了年份，則只顯示該年份資料
              if (this.selectedYear) {
                this.compareResult = uniqueData.filter(row => row.date && row.date.startsWith(this.selectedYear));
              } else {
                this.compareResult = uniqueData;
              }
              console.log('比較結果:', this.compareResult.length, '筆資料');
            } catch (error) {
              console.error('fetchCompareData 錯誤:', error);
              alert('查詢比較資料失敗，請稍後再試');
            }
          },
          // 新增：根據查詢結果繪製主國家與比較國家的價格走勢
          renderChart() {
            // 註解：繪製 Chart.js 折線圖，顯示主國家與比較國家 local_price 走勢
            const ctx = document.getElementById('bigmacChart');
            if (!ctx) {
              console.log('找不到圖表 canvas 元素');
              return;
            }

            // 檢查是否有資料
            if (!this.sortedResult || this.sortedResult.length === 0) {
              console.log('沒有資料可顯示圖表');
              return;
            }

            // 銷毀舊圖表
            if (this.chartInstance) {
              this.chartInstance.destroy();
              this.chartInstance = null;
            }

            // 準備主國家資料
            const mainData = this.sortedResult.map(row => row.local_price);
            const labels = this.sortedResult.map(row => row.date);

            // 準備比較國家資料
            const compareData = this.sortedCompareResult.map(row => row.local_price);

            console.log('主國家資料:', mainData);
            console.log('標籤:', labels);
            console.log('比較國家資料:', compareData);

            // Chart.js 配置
            const datasets = [
              {
                label: this.selectedName,
                data: mainData,
                borderColor: '#007bff',
                backgroundColor: 'rgba(0,123,255,0.1)',
                tension: 0.2,
                fill: false
              }
            ];

            // 如果有比較國家資料，加入比較線
            if (this.compareCountry && this.sortedCompareResult.length > 0) {
              datasets.push({
                label: this.compareCountry,
                data: compareData,
                borderColor: '#ff9800',
                backgroundColor: 'rgba(255,152,0,0.1)',
                tension: 0.2,
                fill: false
              });
            }

            try {
              this.chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                  labels: labels,
                  datasets: datasets
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    legend: { display: true },
                    title: {
                      display: true,
                      text: 'Big Mac 當地價格走勢'
                    }
                  },
                  scales: {
                    x: {
                      title: { display: true, text: '日期' }
                    },
                    y: {
                      title: { display: true, text: '當地價格' }
                    }
                  }
                }
              });
              console.log('圖表已成功建立');
            } catch (error) {
              console.error('建立圖表時發生錯誤:', error);
            }
          }
        },
        computed: {
          // 根據選擇的排序方式返回排序後的結果
          sortedResult() {
            // 修正：先根據年份篩選，再進行排序
            let filteredData = this.result;

            // 如果選擇了年份，則只顯示該年份的資料
            if (this.selectedYear) {
              filteredData = this.result.filter(row =>
                row.date && row.date.startsWith(this.selectedYear)
              );
            }

            return filteredData.slice().sort((a, b) => {
              const dateA = new Date(a.date);
              const dateB = new Date(b.date);
              return this.sortOrder === 'asc' ? dateA - dateB : dateB - dateA;
            });
          },
          // 新增：排序後的比較結果
          sortedCompareResult() {
            // 修正：先根據年份篩選，再進行排序
            let filteredData = this.compareResult;

            // 如果選擇了年份，則只顯示該年份的資料
            if (this.selectedYear) {
              filteredData = this.compareResult.filter(row =>
                row.date && row.date.startsWith(this.selectedYear)
              );
            }

            return filteredData.slice().sort((a, b) => {
              const dateA = new Date(a.date);
              const dateB = new Date(b.date);
              return this.sortOrder === 'asc' ? dateA - dateB : dateB - dateA;
            });
          }
        },
        watch: {
          // 當選擇的 name 改變時，重設年份並自動查詢
          selectedName(newVal, oldVal) {
            // 修正：清空所有相關資料，避免殘留上次查詢結果
            this.result = [];
            this.years = [];
            this.selectedYear = '';

            if (newVal) {
              this.fetchByName();
            }
            // 修正：確保切換國家時立即更新圖表（移除 isChartMode 條件）
            if (newVal) {
              this.$nextTick(() => {
                // 等待資料載入完成後再渲染圖表
                setTimeout(() => this.renderChart(), 100);
              });
            }
          },
          // 當年份變動時自動查詢
          selectedYear(newVal, oldVal) {
            // 修正：年份改變時立即重新查詢，確保資料正確更新
            if (this.selectedName) {
              this.fetchByName();
            }
            // 新增：年份變動時，同步更新比較國家的資料
            if (this.compareCountry) {
              this.fetchCompareData();
            }
            // 修正：確保年份變動時立即更新圖表（移除 isChartMode 條件）
            if (this.selectedName) {
              this.$nextTick(() => {
                // 等待資料載入完成後再渲染圖表
                setTimeout(() => this.renderChart(), 100);
              });
            }
          },
          // 當比較國家變更時，自動查詢該國家資料
          compareCountry(newVal, oldVal) {
            if (newVal) {
              this.fetchCompareData();
            } else {
              this.compareResult = [];
            }
            // 修正：比較國家變動時立即更新圖表（移除 isChartMode 條件）
            if (this.selectedName) {
              this.$nextTick(() => {
                // 等待資料載入完成後再渲染圖表
                setTimeout(() => this.renderChart(), 100);
              });
            }
          },
          // 當排序方式變動時立即更新圖表
          sortOrder(newVal, oldVal) {
            // 修正：排序方式變動時立即更新圖表（移除 isChartMode 條件）
            if (this.result.length) {
              this.$nextTick(() => this.renderChart());
            }
          },
          // 修正：資料變動時自動重繪圖表（移除 isChartMode 條件）
          result() {
            this.$nextTick(() => this.renderChart());
          },
          compareResult() {
            this.$nextTick(() => this.renderChart());
          }
        }
      });

      // 掛載應用並添加錯誤處理
      const mountedApp = app.mount('#app');
      console.log('Vue 應用成功掛載到 #app');

    } catch (error) {
      console.error('Vue 應用初始化失敗:', error);
      // 提供備用的 HTML 內容
      document.getElementById('app').innerHTML = `
        <h1>應用載入失敗</h1>
        <p>Vue 3 應用無法正確初始化，錯誤訊息：${error.message}</p>
        <p>請嘗試以下解決方案：</p>
        <ul>
          <li>重新整理頁面</li>
          <li>檢查網路連線</li>
          <li>確認伺服器正在運行</li>
        </ul>
      `;
    }
  </script>
</body>
</html>
